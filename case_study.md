# Case-study оптимизации импорта данных в БД

## Актуальная проблема

С помощью инструмента siege и таких средств мониторинга, как New Relic и Skylight было выяснено,
что наибольшую проблему представляет из себя index action в StoriesController. Наиболее ясную
статистику представл мониторинг Skylight, но и остальные средства мониторинга указывали на то, что
большую часть времени тратит рендеринг partial'a `_single_story`.

## Формирование метрики

В качестве метрики было выбрано временя рендеринга главноей страницы. Для формирования метрики был
использован иструменты `ab`. Для корректного профилирования была создана среда `profile`, в которой
были использованы настройки, приближенные к `production` среде. В этой среде `ab` показал, что
средний время запроса к оптимизируемой странице занимает 50ms. В качестве бюджета было задано
среднее время запроса в 40 ms.

## Гарантия работы оптимизированной программы

Для гарантии работы оптимизированной программы были использованы уже существующие в приложении
тесты, написанные с помощью библиотеки `rspec`.

## Feedback-Loop

Для эффективной оптимизации был выстроен следующий `feedback-loop`: Профилирование с использованием
`ab` и `siege` и дополнительная проверка результатов с помощью таких средств мониторинга, как
`New Relic` и `SkyLight`-> Оптимизация -> Проверка работы программы с использованием тестов.

## Анализ ассимптотики

Для анализа ассимптотики были исиользованы пакеты `ab` и `siege`. С помощью `siege` была подана
нагрузка на оптимизируемую страницу командой `siege -c 5 -t120s http://localhost:3000` и был
произведен анализ данных средставим мониторинга `New Relic` и `SkyLight`. С помощью `ab` была
выявлена основная метрика.

## Анализ точек роста

Все средства мониторинга указали на то, что основной точкой роста является рендеринг partial'a
`_single_story`.

### Single story caching

В основном на главной странице partial `_single_story` вызывался из другого partial'a -
`_main_stories_feed`. В `_main_stories_feed` вызывается коллекция `@stories` и рендерится каждая
`story`. Исходя из того, что после того, как история создана, пользователи вряд ли будут часто ее
редактировать было принято решение использовать кеширование, а так как перебирается все коллекция
`@stories`, было решено применить `fragment caching`. Данная гипотеза оптимизации была подтверждена
инструментом `ab`, показавшим уменьшение среднего времени реквеста до 37 мс, что укладывается в
бюджент оптимизации. Также `SkyLight` показывает, что теперь рендеринг `_single_story` больше не
оказывает практически никакого влияния на общее время рендеринга страницы.

### Результаты

В результате проведенной оптимизации, которая заключалось в применении фрагментарного кеширования,
удалось снизить среднее время реквеста на главную страницу проекта с 50 мс до 37 мс.
